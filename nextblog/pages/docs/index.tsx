import Affix from "../../components/Affix";
import CheckBroad from "../../views/CheckBroad";
import classNames from "classnames";
import DocsList from "../../views/DocsList";
import FireworkCanvas from "../../components/FireworkCanvas";
import Head from "next/head";
import Header from "../../views/HeaderLOGO";
import NavLink from "../../components/NavLink";
import PinnedListBroad from "../../views/PinnedList";
import { Button, Modal, SSRProvider } from "react-bootstrap";
import { fetchFilterTagsData, fetchPinnedListData } from "../../api-ajax/SSR-ajax";
import { GetServerSideProps } from "next";
import { PinnedListModel } from "../../model/PinnedListModel";
import { useAppDispatch } from "../../redux/_store";
import { useSelector } from "react-redux";
import { DocsCheckerState, fetchCheckedDocsList, selectCheckerState } from "../../redux/DocsCheckerSlice";
import { useEffect, useRef, useState } from "react";

function Docs(props: { fetchedFilterTagsData: string[]; fetchedPinnedListData: PinnedListModel }) {
  const dispatch = useAppDispatch();
  const checker_state = useSelector<DocsCheckerState, DocsCheckerState>(selectCheckerState);
  const last_list_count = useRef<number>(0);
  const [modal_show, set_modal_show] = useState({ text: "", show: false });

  const handleModalClose = () => {
    set_modal_show({
      text: undefined!,
      show: false,
    });
  };
  const handleLoadMore = () => {
    last_list_count.current = checker_state.list.length;
    dispatch(
      fetchCheckedDocsList({
        search_tags: checker_state.factor.search_tags,
        search_terms: checker_state.factor.search_terms,
        outset: checker_state.list[checker_state.list.length - 1].postDate,
      })
    );
  };
  useEffect(() => {
    if (checker_state.list.length !== 0 && checker_state.list.length - last_list_count.current === 0) {
      set_modal_show({ text: "加载已经到底了！", show: true });
    }
  }, [checker_state.list]);

  return (
    <SSRProvider>
      <div className=" tw-select-none ">
        <FireworkCanvas />
        <Head>
          <title>张宇腾MyBlog-归档</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>
        <Affix direction={"top"} space={0}>
          <nav className=" tw-flex tw-justify-center tw-py-2 tw-border-b tw-bg-white">
            <NavLink content={"Home"} checked={false} href="/" />
            <NavLink content={"Docs"} checked={true} href="/docs" />
          </nav>
        </Affix>
        <main className={classNames("tw-mx-auto", "tw-grid", "tw-grid-flow-row", "tw-grid-cols-1", "md:tw-grid-cols-3", "lg:tw-grid-cols-4", "tw-subpixel-antialiased")}>
          <div className={classNames("tw-px-5", "md:tw-col-span-1", "lg:tw-col-span-1")}>
            <header className=" tw-mt-6">
              <Header />
            </header>
            <Affix direction={"top"} space={90}>
              <CheckBroad tags={props.fetchedFilterTagsData} />
            </Affix>
          </div>
          <div className={classNames("tw-border-l", "tw-border-r", "md:tw-col-span-2", "lg:tw-col-span-2")}>
            <DocsList list={checker_state.list} />
            <div className=" tw-my-4 tw-flex tw-justify-center">
              <Button className="shadow-none" as="div" onClick={handleLoadMore}>
                {"加载更多"}
              </Button>
            </div>
          </div>
          <div className={classNames("tw-pt-4", "tw-px-5", "md:tw-col-span-3", "lg:tw-col-span-1")}>
            <Affix direction={"top"} space={90}>
              <PinnedListBroad list={props.fetchedPinnedListData} />
            </Affix>
          </div>
        </main>
      </div>
      <Modal show={modal_show.show} onHide={handleModalClose} centered>
        <Modal.Body>
          {modal_show.text}
          <div className="d-flex justify-content-end">
            <Button as="div" variant="primary" onClick={handleModalClose}>
              {"关闭"}
            </Button>
          </div>
        </Modal.Body>
      </Modal>
    </SSRProvider>
  );
}

export const getServerSideProps: GetServerSideProps = async (context) => {
  return {
    props: {
      fetchedFilterTagsData: (await fetchFilterTagsData()).data,
      fetchedPinnedListData: (await fetchPinnedListData()).data,
    },
  };
};

export default Docs;
